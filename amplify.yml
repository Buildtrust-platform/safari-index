version: 1
applications:
  - appRoot: frontend/safari-index
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - npm run validate-env
        postBuild:
          commands:
            # Sync images to S3/CloudFront CDN for long-term caching
            - |
              if [ -n "$ASSETS_S3_BUCKET" ]; then
                echo "Syncing images to CDN bucket: $ASSETS_S3_BUCKET"
                aws s3 sync public/images "s3://$ASSETS_S3_BUCKET/images" \
                  --cache-control "public, max-age=31536000, immutable"
                # Invalidate CloudFront cache if distribution ID is set
                if [ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
                  echo "Invalidating CloudFront cache..."
                  aws cloudfront create-invalidation \
                    --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
                    --paths "/images/*" || true
                fi
              else
                echo "ASSETS_S3_BUCKET not set, skipping CDN sync"
              fi
        build:
          commands:
            - echo "Building with NEXT_PUBLIC_APP_MODE=$NEXT_PUBLIC_APP_MODE"
            - npm run build
            # Create Amplify hosting structure for Next.js standalone
            - mkdir -p .amplify-hosting/compute/default
            - mkdir -p .amplify-hosting/static/_next
            # Copy standalone server
            - cp -r .next/standalone/. .amplify-hosting/compute/default/
            # Copy static files
            - cp -r .next/static .amplify-hosting/static/_next/
            - cp -r public/. .amplify-hosting/static/ 2>/dev/null || true
            # Create deploy manifest
            - |
              cat > .amplify-hosting/deploy-manifest.json << 'EOF'
              {
                "version": 1,
                "routes": [
                  {
                    "path": "/_next/static/*",
                    "target": {
                      "kind": "Static"
                    }
                  },
                  {
                    "path": "/*.*",
                    "target": {
                      "kind": "Static"
                    },
                    "fallback": {
                      "kind": "Compute",
                      "src": "default"
                    }
                  },
                  {
                    "path": "/*",
                    "target": {
                      "kind": "Compute",
                      "src": "default"
                    }
                  }
                ],
                "computeResources": [
                  {
                    "name": "default",
                    "entrypoint": "server.js",
                    "runtime": "nodejs20.x"
                  }
                ],
                "framework": {
                  "name": "next",
                  "version": "16.1.0"
                }
              }
              EOF
      artifacts:
        baseDirectory: .amplify-hosting
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
